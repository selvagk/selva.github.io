'use strict';(function(k,f){"object"===typeof exports&&"undefined"!==typeof module?f(exports,require("three"),require("troika-core"),require("troika-three-utils"),require("react"),require("prop-types")):"function"===typeof define&&define.amd?define("exports three troika-core troika-three-utils react prop-types".split(" "),f):(k=k||self,f(k.troika_3d={},k.THREE,k.troika_core,k.troika_three_utils,k.React,k.PropTypes))})(this,function(k,f,m,v,y,r){function ma(c,b){return c.distance-b.distance}function P(c){return!1===
c.isRenderable&&(!c.children.length||c.children.every(P))}function Q(c,b,a){function d(a,d){Object.defineProperty(g.prototype,a,{set:function(b){b!==this.threeObject[a]&&(this.threeObject[a]=b,d&&(this._projectionChanged=!0))},get:function(){return this.threeObject[a]}})}var g=function(a){function d(d){var b=new c;a.call(this,d,b);this._projectionChanged=!1;this._frustum=new f.Frustum;b.updateMatrixWorld=oa}a&&(d.__proto__=a);d.prototype=Object.create(a&&a.prototype);d.prototype.constructor=d;d.prototype.updateMatrices=
function(){var d=this.threeObject;this._projectionChanged&&(d.updateProjectionMatrix(),this._projectionChanged=!1,this._projectionMatrixVersion=pa++);var b=this._worldMatrixVersion;a.prototype.updateMatrices.call(this);b!==this._worldMatrixVersion&&d.matrixWorldInverse.getInverse(d.matrixWorld)};d.prototype.getFrustum=function(){this.updateMatrices();var a=this._frustum,d=this._worldMatrixVersion,b=this._projectionMatrixVersion;if(a._lastWorldMatrixVersion!==d||a._lastProjMatrixVersion!==b){var c=
this.threeObject;c=(new f.Matrix4).multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);a.setFromMatrix(c);a._lastWorldMatrixVersion=d;a._lastProjMatrixVersion=b}return a};d.prototype.getRayAtProjectedCoords=function(a,d){var b=R.ray=new f.Ray;R.setFromCamera(qa.set(a,d),this.threeObject);return b};return d}(q);b.forEach(function(a){d(a,!0)});a&&a.forEach(function(a){d(a,!1)});return g}function E(c){return function(b){function a(a){b.call(this,a,new c)}b&&(a.__proto__=b);a.prototype=Object.create(b&&
b.prototype);return a.prototype.constructor=a}(S)}function K(c,b,a){void 0===a&&(a=[]);c=v.expandShaderIncludes(c);b=v.expandShaderIncludes(b);var d=T.test(c),g=U.test(c),e=V.test(c),l=v.getShaderUniformTypes(c),f=v.getShaderUniformTypes(b),h=["\nattribute vec4 troika_modelMatrixRow0;\nattribute vec4 troika_modelMatrixRow1;\nattribute vec4 troika_modelMatrixRow2;\n"],n=[],w=[];if(d||g||e)c=c.replace(T,F),n.push(ra);if(g||e)c=c.replace(U,F),n.push("\nmat4 troika_modelViewMatrix = viewMatrix * troika_modelMatrix;\n");
e&&(c=c.replace(V,F),n.push("\nmat3 troika_normalMatrix = transposeMat3(inverse(mat3(troika_modelViewMatrix)));\n"),/\binverse\s*\(/.test(c)||h.push("\n#if __VERSION__ < 300\n// matrix inversion utility for pre-ES3 - credit https://github.com/stackgl/glsl-inverse\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(\n    b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n    b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n    b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)\n  ) / det;\n}\n#endif\n"));
a.forEach(function(a){var d=l[a],g=f[a];if(d||g){var e=new RegExp("\\b"+a+"\\b","g");h.push("attribute "+(d||g)+" troika_"+a+";");d&&(c=c.replace(e,F));g&&(b=b.replace(e,sa),d="varying "+g+" troika_vary_"+a+";",h.push(d),w.push(d),n.push("troika_vary_"+a+" = troika_"+a+";"))}});c=c.replace(v.voidMainRegExp,"\n"+h.join("\n")+"\n$&\n"+n.join("\n")+"\n");w.length&&(b=b.replace(v.voidMainRegExp,"\n"+w.join("\n")+"\n$&\n    "));return{vertexShader:c,fragmentShader:b}}function W(c,b,a){var d=c.itemSize;
1===d?c.setX(b,a):2===d?c.setXY(b,a.x,a.y):3===d?a.isColor?c.setXYZ(b,a.r,a.g,a.b):c.setXYZ(b,a.x,a.y,a.z):4===d&&c.setXYZW(b,a.x,a.y,a.z,a.w)}y=y&&y.hasOwnProperty("default")?y["default"]:y;r=r&&r.hasOwnProperty("default")?r["default"]:r;var L=m.utils.assign,X=m.utils.forOwn,G=new f.Vector3,Y=new f.Matrix4,B=new f.Quaternion,Z=new f.Vector3(0,1,0),t=function(){var c={callback:function(b){c.value=b},value:null};return c}(),ta={type:"removed"},C=[],ua=0,va=0,q=function(c){function b(a,d){c.call(this,
a);d.matrixAutoUpdate=!1;this.threeObject=d;d.$facade=this;var b=!1!==d.isRenderable;b||(d.layers.mask=0);for(;a;){if(a.isObject3DFacade){this._parentObject3DFacade=a;b&&this._addToThreeObjectTree();break}a=a.parent}this.notifyWorld("object3DAdded")}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=b;b.prototype.afterUpdate=function(){this.lookAt&&(G.copy(this.lookAt),Z.copy(this.up||f.Object3D.DefaultUp),Y.lookAt(this.threeObject.position,G,Z),B.setFromRotationMatrix(Y),
this.quaternionX=B.x,this.quaternionY=B.y,this.quaternionZ=B.z,this.quaternionW=B.w);this.updateMatrices();this._checkBoundsChange();this._worldMatrixVersion>this._worldMatrixVersionAfterLastUpdate&&(this.shouldUpdateChildren()||this.traverse(function(a,d){a!==d&&a.updateMatrices&&(a.updateMatrices(),a._checkBoundsChange())},this),this._worldMatrixVersionAfterLastUpdate=this._worldMatrixVersion);c.prototype.afterUpdate.call(this);if(this._removeChildIds){var a=this.threeObject,d=this._removeChildIds;
a.children=a.children.filter(function(a){return a.id in d?(a.parent=null,a.dispatchEvent(ta),!1):!0});var b=this._parentObject3DFacade;P(a)&&b&&b.threeObject===a.parent&&b._queueRemoveChildObject3D(a.id);this._removeChildIds=null}};b.prototype.updateMatrices=function(){var a=this.threeObject,d=this._parentObject3DFacade;if(this._matrixChanged){a.matrix.compose(a.position,a.quaternion,a.scale);this._matrixChanged=!1;var b=!0}else b=d&&d._worldMatrixVersion>this._worldMatrixVersion;if(b){d?a.matrixWorld.multiplyMatrices(d.threeObject.matrixWorld,
a.matrix):a.matrixWorld.copy(a.matrix);a=a.children;d=0;for(b=a.length;d<b;d++)a[d].$facade||a[d].updateMatrixWorld(!0);this.markWorldMatrixDirty()}};b.prototype.markWorldMatrixDirty=function(){this._worldMatrixVersion=++ua;this._boundsChanged=!0};b.prototype._checkBoundsChange=function(){var a=this._boundsChanged;if(!a){var d=this._getGeometryBoundingSphere();d&&d.version!==this._lastGeometrySphereVersion&&(a=!0,this._lastGeometrySphereVersion=d.version)}a&&(this.notifyWorld("object3DBoundsChanged"),
this._boundsChanged=!1)};b.prototype.getWorldPosition=function(a){void 0===a&&(a=new f.Vector3);this.updateMatrices();a.setFromMatrixPosition(this.threeObject.matrixWorld);return a};b.prototype.getCameraPosition=function(){t.value=null;this.notifyWorld("getCameraPosition",t);return t.value};b.prototype.getCameraFacade=function(){t.value=null;this.notifyWorld("getCameraFacade",t);return t.value};b.prototype.getCameraDistance=function(){var a=this.getCameraPosition(),d=this.getWorldPosition(G);return a.distanceTo(d)};
b.prototype.getProjectedPosition=function(a,d,b){this.updateMatrices();t.value=null;t.worldPosition=G.set(a||0,d||0,b||0).applyMatrix4(this.threeObject.matrixWorld);this.notifyWorld("projectWorldPosition",t);return t.value};b.prototype.getSceneFacade=function(){t.value=null;this.notifyWorld("getSceneFacade",t);return t.value};b.prototype.getBoundingSphere=function(){var a=this._getGeometryBoundingSphere();if(!a)return null;this.updateMatrices();var d=this._boundingSphere;d||(d=this._boundingSphere=
new f.Sphere);if(d._geometrySphereVersion!==a.version||d._worldMatrixVersion!==this._worldMatrixVersion)d.copy(a),d.applyMatrix4(this.threeObject.matrixWorld),d._worldMatrixVersion=this._worldMatrixVersion,d._geometrySphereVersion=a.version;return d};b.prototype._getGeometryBoundingSphere=function(){var a=this.getGeometry();if(a){var d=a.boundingSphere,b=!1;if(d)if(a.isBufferGeometry){var c=a.attributes.position;c&&d._posAttrVersion!==c.version&&(a.computeBoundingSphere(),d._posAttrVersion=c.version,
b=!0)}else a._lastBoundingSphere&&d.equals(a._lastBoundingSphere)||(a._lastBoundingSphere=d.clone(),b=!0);else a.computeBoundingSphere(),d=a.boundingSphere,b=!0;b&&(d.version=++va);return d}return null};b.prototype.getGeometry=function(){var a=this.threeObject;return a&&a.geometry};b.prototype.raycast=function(a){return this.threeObject?this._raycastObject(this.threeObject,a):null};b.prototype._raycastObject=function(a,d){if(a.visible){C.length=0;var b=null,c=this.raycastSide;null!=c&&(b=a.material.side,
a.material.side=c);a.raycast(d,C);null!==b&&(a.material.side=b);if(C.length)return C.sort(ma),C.slice()}return null};b.prototype._addToThreeObjectTree=function(){var a=this._parentObject3DFacade;a&&this.threeObject.parent!==a.threeObject&&(a.threeObject.add(this.threeObject),a._addToThreeObjectTree())};b.prototype._queueRemoveChildObject3D=function(a){(this._removeChildIds||(this._removeChildIds=Object.create(null)))[a]=!0};b.prototype.destructor=function(){this.notifyWorld("object3DRemoved");var a=
this._parentObject3DFacade;a&&a._queueRemoveChildObject3D(this.threeObject.id);delete this.threeObject;c.prototype.destructor.call(this)};return b}(m.PointerEventTarget);["castShadow","receiveShadow","renderOrder","visible"].forEach(function(c){Object.defineProperty(q.prototype,c,{get:function(){return this.threeObject[c]},set:function(b){this.threeObject[c]=b}})});q.prototype.raycastSide=null;X({position:{x:"x",y:"y",z:"z"},scale:{x:"scaleX",y:"scaleY",z:"scaleZ"},rotation:{x:"rotateX",y:"rotateY",
z:"rotateZ",order:"rotateOrder"},quaternion:{x:"quaternionX",y:"quaternionY",z:"quaternionZ",w:"quaternionW"}},function(c,b){X(c,function(a,d){Object.defineProperty(q.prototype,a,{get:(new Function("return function "+a+"$get() {\n  return this.threeObject."+b+"."+d+"\n}"))(),set:(new Function("return function "+a+"$set(value) {\n  //let obj = this.threeObject."+b+"\n  if (this.threeObject."+b+"."+d+" !== value) {\n    this.threeObject."+b+"."+d+" = value\n    if (!this._matrixChanged) {\n      this._matrixChanged = true\n    }\n  }\n}"))()})})});
Object.defineProperty(q.prototype,"scale",{get:function(){return this.threeObject.scale.x},set:function(c){var b=this.threeObject.scale;if(c!==b.x||c!==b.y||c!==b.z)b.x=b.y=b.z=c,this._matrixChanged||(this._matrixChanged=!0)}});Object.defineProperty(q.prototype,"isObject3DFacade",{value:!0});L(q.prototype,{lookAt:null,threeObject:null,_parentObject3DFacade:null,_removeChildIds:null,_matrixChanged:!0,_worldMatrixVersion:-1,_worldMatrixVersionAfterLastUpdate:-1,_boundingSphereChanged:!1});m.Facade.defineEventProperty(q,
"onBeforeRender","beforerender");m.Facade.defineEventProperty(q,"onAfterRender","afterrender");var oa=function(){},R=new f.Raycaster,qa=new f.Vector2,pa=0,aa=Q(f.PerspectiveCamera,["fov","aspect","near","far"],["focus","filmGauge","filmOffset"]);L=Q(f.OrthographicCamera,"left right top bottom near far".split(" "));var ba=function(c){function b(a){var d=new f.Group;d.isRenderable=!1;c.call(this,a,d)}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);return b.prototype.constructor=b}(q),wa=
function(c){function b(a){var d=new f.Object3D;d.isRenderable=!1;c.call(this,a,d);this.html=null;this.exact=!1;this.notifyWorld("addHtmlOverlay",this)}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=b;b.prototype.destructor=function(){this.notifyWorld("removeHtmlOverlay",this);c.prototype.destructor.call(this)};return b}(q),S=function(c){function b(){c.apply(this,arguments)}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=b;
var a={color:{configurable:!0},shadow:{configurable:!0}};a.color.set=function(a){this.threeObject.color.set(a)};a.shadow.get=function(){return this.threeObject.shadow};a.shadow.set=function(a){m.utils.assignDeep(this.threeObject.shadow,a)};Object.defineProperties(b.prototype,a);return b}(q);"intensity distance angle penumbra decay castShadow".split(" ").forEach(function(c){Object.defineProperty(S.prototype,c,{get:function(){return this.threeObject[c]},set:function(b){this.threeObject[c]=b}})});var ca=
E(f.AmbientLight),da=E(f.DirectionalLight),ea=E(f.SpotLight),fa=E(f.PointLight),ra="\nmat4 troika_modelMatrix = mat4(\n  %0.x, %1.x, %2.x, 0.0,\n  %0.y, %1.y, %2.y, 0.0,\n  %0.z, %1.z, %2.z, 0.0,\n  %0.w, %1.w, %2.w, 1.0\n);\n".replace(/%/g,"troika_modelMatrixRow"),T=/\bmodelMatrix\b/g,U=/\bmodelViewMatrix\b/g,V=/\bnormalMatrix\b/g,ha=/\buniform\s+(int|float|vec[234])\s+$/,F=function(c,b,a){return ha.test(a.substr(0,b))?c:"troika_"+c},sa=function(c,b,a){return ha.test(a.substr(0,b))?c:"troika_vary_"+
c},z=m.utils.assign,xa=m.utils.assignIf,M=function(c){function b(a){c.call(this,a);this._instanceables=Object.create(null);this._batchGeometryPool=new H;this._needsRebatch=!0;this.addEventListener("beforerender",this._setupBatchObjects.bind(this));this.addEventListener("afterrender",this._teardownBatchObjects.bind(this))}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=b;b.prototype.onNotifyWorld=function(a,d,b){var c=this._notifyWorldHandlers[d];if(c)c.call(this,
a,b);else if(this.parent)this.parent.onNotifyWorld(a,d,b)};b.prototype._setupBatchObjects=function(a,d,b){b=this._instanceables;a=this._batchObjectsByKey;var c=this._needsRebatch;if(!c)for(var g in a)if(this._getBatchKey(a[g][0].$troikaBatchBaseObj)!==g){c=!0;break}if(c){a=this._batchObjectsByKey=Object.create(null);g=this._batchGeometryPool;for(var f in b){c=b[f];var h=c.threeObject,n=c.instancedThreeObject;if(n&&h.visible){var w=this._getBatchKey(n),k=n.material.instanceUniforms,m=a[w]||(a[w]=[]),
q=(w=m[m.length-1])&&w.geometry;if(!q||1024===q.maxInstancedCount){w=this._getBatchObject(n);q=w.geometry;for(var r=q._instanceAttrs.matrix,p=0;3>p;p++)r[p].version++;if(k)for(r=q._instanceAttrs.uniforms,p=k.length;p--;)r[k[p]].version++;m.push(w)}m=q.maxInstancedCount++;r=q._instanceAttrs.matrix;h=h.matrixWorld.elements;r[0].setXYZW(m,h[0],h[4],h[8],h[12]);r[1].setXYZW(m,h[1],h[5],h[9],h[13]);r[2].setXYZW(m,h[2],h[6],h[10],h[14]);if(k)for(r=q._instanceAttrs.uniforms,h=k.length;h--;){p=k[h];q=r[p];
var t=c._instanceUniforms;p=t&&p in t?t[p]:v.getShadersForMaterial(n.material).uniforms[p].value;W(q,m,p)}c._instancingBatchObject=w;c._instancingBatchAttrOffset=m}else c._instancingBatchObject=c._instancingBatchAttrOffset=null}g.disposeUnused()}g=b=f=0;for(var u in a)for(c=a[u],d.children.push.apply(d.children,c),b++,n=c.length;n--;)f++,g+=c[n].geometry.maxInstancedCount;this.notifyWorld("statsUpdate",{"Instancing Batch Groups":b,"Instancing Batches":f,"Instanced Objects":g});this._needsRebatch=
!1};b.prototype._onInstanceAdded=function(a){this._instanceables[a.$facadeId]=a;this._needsRebatch=!0};b.prototype._onInstanceRemoved=function(a){delete this._instanceables[a.$facadeId];this._needsRebatch=!0};b.prototype._onInstanceChanged=function(a){this._needsRebatch=!0};b.prototype._onInstanceMatrixChanged=function(a){if(!this._needsRebatch){var d=a.instancedThreeObject,b=a._instancingBatchObject,c=a._instancingBatchAttrOffset;d&&b&&this._getBatchKey(d)===this._getBatchKey(b)?(d=b.geometry._instanceAttrs.matrix,
a=a.threeObject.matrixWorld.elements,d[0].setXYZW(c,a[0],a[4],a[8],a[12]).version++,d[1].setXYZW(c,a[1],a[5],a[9],a[13]).version++,d[2].setXYZW(c,a[2],a[6],a[10],a[14]).version++):(a._instancingBatchObject=a._instancingBatchAttrOffset=null,this._needsRebatch=!0)}};b.prototype._onInstanceUniformChanged=function(a,b){if(!this._needsRebatch){var d=a.instancedThreeObject,c=a._instancingBatchObject;d&&c&&this._getBatchKey(d)===this._getBatchKey(c)?(d=c.geometry._instanceAttrs.uniforms[b],W(d,a._instancingBatchAttrOffset,
a._instanceUniforms[b]),d.version++):(a._instancingBatchObject=a._instancingBatchAttrOffset=null,this._needsRebatch=!0)}};b.prototype._getBatchKey=function(a){var b=this._batchKeysCache||(this._batchKeysCache=Object.create(null)),c=b&&b[a.id];if(!c){c=a.material;var e=v.getShadersForMaterial(c),l=c.instanceUniforms;c=a.geometry.id+"|"+c.id+"|"+e.vertexShader+"|"+e.fragmentShader+"|"+(l?l.sort().join(","):"");b[a.id]=c}return c};b.prototype._getInstanceUniformsTypes=function(a){var b=this._uniformTypesCache||
(this._uniformTypesCache=Object.create(null)),c=b[a.id];if(!c&&(c=b[a.id]=Object.create(null),(b=a.instanceUniforms)&&b.length)){a=v.getShadersForMaterial(a);var e=a.fragmentShader;a=z(v.getShaderUniformTypes(v.expandShaderIncludes(a.vertexShader)),v.getShaderUniformTypes(v.expandShaderIncludes(e)));for(e=b.length;e--;){var l=b[e];a[l]&&(c[l]=a[l])}}return c};b.prototype._getBatchObject=function(a){var b,c=a.geometry,e=a.material;if(!c.isBufferGeometry)throw Error("Instanceable proto object must use a BufferGeometry");
var l=this._getBatchKey(a),na=this._getInstanceUniformsTypes(e);c=this._batchGeometryPool.borrow(l,c,na);c.maxInstancedCount=0;l=Object.create(e);var h=e.instanceUniforms||[];h.sort();l.defines=xa((b={},b["TROIKA_INSTANCED_"+h.join("_")]="",b),l.defines);l.onBeforeCompile=function(a){var b=e.$troikaUpgraded,c=a.vertexShader+"|"+a.fragmentShader+"|"+h.join(",");b&&b.upgradeKey===c||(b=e.$troikaUpgraded=K(a.vertexShader,a.fragmentShader,h),b.upgradeKey=c);z(a,b)};var n=null;b=Object.create(a,{customDepthMaterial:{get:function(){return n=
ia()}},customDistanceMaterial:{get:function(){return n=ja()}},modelViewMatrix:{value:function(){var a=new f.Matrix4;a.multiplyMatrices=function(a,b){f.Matrix4.prototype.multiplyMatrices.call(this,a,b);n&&n._updateViewMatrix&&n._updateViewMatrix(a)};return a}()}});b.$troikaBatchBaseObj=a;b.$troikaInstancingManager=this;b.visible=!0;b.frustumCulled=!1;b.geometry=c;b.material=l;return b};b.prototype._teardownBatchObjects=function(a,b,c){var d=this;this._batchGeometryPool.releaseAll();this._uniformTypesCache=
this._batchKeysCache=null;b.children=b.children.filter(function(a){return a.$troikaInstancingManager!==d})};b.prototype.destructor=function(){var a=this._batchGeometryPool;a.releaseAll();a.disposeUnused();c.prototype.destructor.call(this)};return b}(ba),H=function(){this._poolsByKey=Object.create(null)};H.prototype.borrow=function(c,b,a){var d=this._poolsByKey;c=d[c]||(d[c]={geometries:[],firstFree:0});d=c.geometries[c.firstFree++];if(!d){d=new f.InstancedBufferGeometry;z(d,b);d.attributes=z({},b.attributes);
b=d._instanceAttrs={matrix:[],uniforms:Object.create(null)};for(var g=0;3>g;g++){var e=new f.InstancedBufferAttribute(new Float32Array(4096),4);e.setUsage?e.setUsage(35048):e.dynamic=!0;d.attributes["troika_modelMatrixRow"+g]=e;b.matrix[g]=e}for(var l in a)g=a[l],e=ya[g],g=new f.InstancedBufferAttribute(new ("int"===g?Uint32Array:Float32Array)(1024*e),e),g.setUsage?g.setUsage(35048):g.dynamic=!0,d.attributes["troika_"+l]=g,b.uniforms[l]=g;c.geometries.push(d)}return d};H.prototype.releaseAll=function(){var c=
this._poolsByKey;if(c)for(var b in c)c[b].firstFree=0};H.prototype.disposeUnused=function(){var c=this._poolsByKey;if(c)for(var b in c){var a=c[b],d=a.firstFree;a=a.geometries;for(var g=d,e=a.length;g<e;g++){var l=a[g].attributes,f;for(f in l)l.hasOwnProperty(f)&&0!==f.indexOf("troika_")&&delete l[f];try{a[g].dispose()}catch(h){}a[g]._instanceAttrs=null}a.length=d}};var x=M.prototype;x._notifyWorldHandlers={instanceableAdded:x._onInstanceAdded,instanceableRemoved:x._onInstanceRemoved,instanceableChanged:x._onInstanceChanged,
instanceableMatrixChanged:x._onInstanceMatrixChanged,instanceableUniformChanged:x._onInstanceUniformChanged};var ya={"int":1,"float":1,vec2:2,vec3:3,vec4:4},ia=function(){var c=z({},f.ShaderLib.depth);c.vertexShader=K(c.vertexShader,"",[]).vertexShader;var b=new f.ShaderMaterial(c);b.isMeshDepthMaterial=!0;b.depthPacking=f.RGBADepthPacking;ia=function(){return b};return b},ja=function(){var c=z({},f.ShaderLib.distanceRGBA),b=new f.Matrix4;c.vertexShader=K(c.vertexShader,"",[]).vertexShader;c.uniforms=
z({viewMatrix:{value:b}},c.uniforms);var a=new f.ShaderMaterial(c);a.isMeshDistanceMaterial=!0;a.referencePosition=new f.Vector3;a._updateViewMatrix=function(c){b.copy(c);a.uniformsNeedUpdate=!0};ja=function(){return a};return a},za={ambient:ca,directional:da,spot:ea,point:fa},Aa=[{distance:Infinity}],Ba=new f.Sphere(void 0,Infinity),ka=function(c){function b(a){var b=new f.Scene;b.autoUpdate=!1;c.call(this,a,b)}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=
b;var a={fog:{configurable:!0}};b.prototype.afterUpdate=function(){var a={key:"instancingMgr",facade:M,children:this.objects};this.lights&&this.lights.length&&(a=this.lights.map(function(a,b){var c=m.utils.assign({},a);delete c.type;c.key="$$$light_"+b;c.facade=c.facade||za[a.type];return c.facade?c:null}).concat(a));this.children=a;c.prototype.afterUpdate.call(this)};a.fog.set=function(a){var b=this._fogObj;if(a){var c="density"in a,d=c?f.FogExp2:f.Fog;b&&b instanceof d||(b=this._fogObj=new d);b.color.set(a.color);
c?b.density=a.density:(b.near=a.near,b.far=a.far)}else b=this._fogObj=null;this.threeObject.fog=b};b.prototype.getBoundingSphere=function(){return Ba};b.prototype.raycast=function(a){return Aa};Object.defineProperties(b.prototype,a);return b}(q);x=m.utils.assign;var Ca=m.utils.forOwn,N=new f.Sphere,Da=Math.sqrt(3),u=function(){this.root=null;this.keysToLeaves=Object.create(null)};u.prototype.putSpheres=function(c){var b=this;Ca(c,function(a,c){b.putSphere(c,a)})};u.prototype.putSphere=function(c,
b){var a=this,d=b.center,g=b.radius,e=this.root;if(!b||isNaN(g)||isNaN(d.x))console.warn("Invalid sphere",b);else{if(c in this.keysToLeaves)return this._updateSphere(c,b);if(e)if(e.isLeaf){g=this.root;var l=e.dataX,f=e.dataY,h=e.dataZ;if(l===d.x&&f===d.y&&h===d.z)this._insertIntoOctant(c,b,e);else{var n=new p;e=n.cx=Math.round((l+d.x)/2);var k=n.cy=Math.round((f+d.y)/2);d=n.cz=Math.round((h+d.z)/2);n.cr=Math.ceil(Math.max(Math.abs(e-l),Math.abs(k-f),Math.abs(d-h))+1E-5);this.root=n;g.forEachLeafSphere(function(b,
c){return a._insertIntoOctant(c,b,n)});this._insertIntoOctant(c,b,n)}}else this._expandToCoverPoint(d.x,d.y,d.z),this._insertIntoOctant(c,b,this.root);else d=new p,d.isLeaf=!0,d.addSphereData(c,b),this.root=d,this.keysToLeaves[c]=d}};u.prototype._expandToCoverPoint=function(c,b,a){for(;!this.root.containsPoint(c,b,a);){var d=this.root,g=d.cx,e=d.cy,l=d.cz,f=d.cr,h=new p;h.maxRadius=d.maxRadius;h.sphereCount=d.sphereCount;h.leafCount=d.leafCount;h.cx=g+f*(c<g?-1:1);h.cy=e+f*(b<e?-1:1);h.cz=l+f*(a<
l?-1:1);h.cr=2*f;g=h.getSubOctantIndexForPoint(g,e,l);d.parent=h;d.index=g;h[g]=d;this.root=h}};u.prototype._insertIntoOctant=function(c,b,a){var d=b.center,g=b.radius;if(a.isLeaf){var e=a.dataX,l=a.dataY,f=a.dataZ;if(d.x===e&&d.y===l&&d.z===f){a.addSphereData(c,b);for(b=a.parent;b;b=b.parent)g>b.maxRadius&&(b.maxRadius=g);this.keysToLeaves[c]=a}else g=Ea(a),a.parent[a.index]=g,g.addOctantForPoint(a,e,l,f),this._insertIntoOctant(c,b,g)}else{a.sphereCount++;e=a.getSubOctantIndexForPoint(d.x,d.y,d.z);
if(e=a[e])return this._insertIntoOctant(c,b,e);e=new p;e.isLeaf=!0;a.addOctantForPoint(e,d.x,d.y,d.z);e.addSphereData(c,b);for(a=e.parent;a;a=a.parent)g>a.maxRadius&&(a.maxRadius=g),a.leafCount++;this.keysToLeaves[c]=e}};u.prototype.removeSphere=function(c){var b=this.keysToLeaves[c];if(b){for(var a=b.parent;a;)a.sphereCount--,a=a.parent;if(1<b.sphereCount)b.removeSphereData(c),b.updateMaxRadii();else{a=b;do{var d=a.parent;(b=d)&&(d[a.index]=null);a=a.parent}while(a&&0===a.sphereCount);if(!b){this.root=
null;return}d=null;for(a=b;a;)a.leafCount--,1===a.leafCount&&(d=a),a=a.parent;d?(a=this._findSingleLeaf(d),(b=d.parent)?(b.addOctantForPoint(a,a.cx,a.cy,a.cz),b.updateMaxRadii()):this.root=a):b.updateMaxRadii()}delete this.keysToLeaves[c]}};u.prototype._updateSphere=function(c,b){var a=this.keysToLeaves[c],d=b.center;if(a.containsPoint(d.x,d.y,d.z)){var g=d.x!==a.dataX||d.y!==a.dataY||d.z!==a.dataZ;1<a.sphereCount&&g?(a.removeSphereData(c),a.updateMaxRadii(),this._insertIntoOctant(c,b,a)):(g&&(a.dataX=
d.x,a.dataY=d.y,a.dataZ=d.z),b.radius!==a.maxRadius&&a.updateMaxRadii())}else this.removeSphere(c),this.putSphere(c,b)};u.prototype._findSingleLeaf=function(c){function b(a){a.isLeaf&&(d=a)}function a(a){d=null;this.walkBranch(a,b);return d}var d;this._findSingleLeaf=a;return a.call(this,c)};u.prototype.walkTree=function(c){this.root&&this.walkBranch(this.root,c)};u.prototype.walkBranch=function(c,b){if(!1!==b(c)&&!c.isLeaf)for(var a=0;8>a;a++)null!==c[a]&&this.walkBranch(c[a],b)};u.prototype.forEachSphereOnRay=
function(c,b,a){return this._forEachMatchingSphere(c.intersectsSphere.bind(c),b,a)};u.prototype.forEachIntersectingSphere=function(c,b,a){return this._forEachMatchingSphere(c.intersectsSphere.bind(c),b,a)};u.prototype._forEachMatchingSphere=function(c,b,a){function d(d,e){c(d)&&b.call(a,d,e)}this.walkTree(function(a){if(a.isLeaf)a.forEachLeafSphere(d);else if(N.center.set(a.cx,a.cy,a.cz),N.radius=a.cr*Da+a.maxRadius,!c(N))return!1;return!0})};var p=function(){};p.prototype.containsPoint=function(c,
b,a){var d=this.cx,g=this.cy,e=this.cz,f=this.cr;return c>=d-f&&c<d+f&&b>=g-f&&b<g+f&&a>=e-f&&a<e+f};p.prototype.getSubOctantIndexForPoint=function(c,b,a){return(a<this.cz?0:4)+(b<this.cy?0:2)+(c<this.cx?0:1)};p.prototype.addOctantForPoint=function(c,b,a,d){var g=this.getSubOctantIndexForPoint(b,a,d),e=this.cr/2;c.parent=this;c.index=g;c.cx=this.cx+e*(b<this.cx?-1:1);c.cy=this.cy+e*(a<this.cy?-1:1);c.cz=this.cz+e*(d<this.cz?-1:1);c.cr=e;return this[g]=c};p.prototype.findMaxSphereRadius=function(){var c=
0;if(this.isLeaf){var b=this.data;if(1<this.sphereCount)for(var a in b){var d=b[a].radius;d>c&&(c=d)}else c=b.radius}else for(b=0;8>b;b++)null!==this[b]&&this[b].maxRadius>c&&(c=this[b].maxRadius);return c};p.prototype.updateMaxRadii=function(){var c=this.findMaxSphereRadius();if(c>this.maxRadius)for(var b=this;b;)c>b.maxRadius&&(b.maxRadius=c),b=b.parent;else c<this.maxRadius&&(this.maxRadius=c,this.parent&&this.parent.updateMaxRadii())};p.prototype.addSphereData=function(c,b){var a=this.sphereCount++;
if(0===a)this.leafCount=1,this.data=b,this.dataKey=c,c=b.center,this.dataX=c.x,this.dataY=c.y,this.dataZ=c.z;else if(1===a){a=this.data;var d=this.data=Object.create(null);d[this.dataKey]=a;d[c]=b;this.dataKey=null}else 1<a&&(this.data[c]=b);b.radius>this.maxRadius&&(this.maxRadius=b.radius)};p.prototype.removeSphereData=function(c){var b=this.data;if(b){var a=this.sphereCount--;if(2<a)delete b[c];else if(2===a)for(var d in b){if(d!==c){this.dataKey=d;this.data=b[d];break}}else this.data=null}};p.prototype.forEachLeafSphere=
function(c,b){var a=this.data;if(a)if(1<this.sphereCount)for(var d in a)c.call(b,a[d],d);else c.call(b,a,this.dataKey)};x(p.prototype,{parent:null,index:-1,cx:0,cy:0,cz:0,cr:0,0:null,1:null,2:null,3:null,4:null,5:null,6:null,7:null,isLeaf:!1,data:null,dataKey:null,dataX:0,dataY:0,dataZ:0,sphereCount:0,leafCount:0,maxRadius:0});var Ea=function(){var c="parent index cx cy cz cr sphereCount leafCount maxRadius".split(" ");return function(b){for(var a=new p,d=c.length;d--;)a[c[d]]=b[c[d]];return a}}(),
D=m.utils.assign,O=new f.Vector2,A=new f.Vector3,la=new f.Raycaster,I=function(c){function b(a){c.call(this,a);this._object3DFacadesById=Object.create(null);this._onBgClick=this._onBgClick.bind(this)}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=b;b.prototype.afterUpdate=function(){var a=this.width,b=this.height,g=this.antialias,e=this.backgroundColor,l=this.contextAttributes,k=this._element,h=this._threeRenderer,n=this.rendererClass||f.WebGLRenderer;h&&h instanceof
n||(h&&h.dispose(),l=D({alpha:!0,antialias:g},l),(h=k.getContext("webgl2",l)||void 0)||console.info("webgl2 init failed, trying webgl"),h=this._threeRenderer=new n(D({canvas:k,context:h},l)));l=this.shadows;h.shadowMap.enabled=!!l;l&&"object"===typeof l&&D(h.shadowMap,l);e!==this._bgColor&&(this._threeRenderer.setClearColor(new f.Color(e||0),null!=e?1:0),this._bgColor=e);this.children=[this._getCameraDef(),this._getSceneDef()];this._updateDrawingBufferSize(a,b,this.pixelRatio||window.devicePixelRatio||
1);c.prototype.afterUpdate.call(this)};b.prototype._getCameraDef=function(){return D({key:"camera",facade:aa,aspect:this.width/this.height},this.camera)};b.prototype._getSceneDef=function(){return{key:"scene",facade:ka,lights:this.lights,objects:this.objects,fog:this.fog,onClick:this.onBackgroundClick?this._onBgClick:null}};b.prototype._updateDrawingBufferSize=function(a,b,c){var d=this._threeRenderer;d.getSize(O);O.width===a&&O.height===b&&d.getPixelRatio()===c||d.setDrawingBufferSize(a,b,c)};b.prototype.doRender=
function(){function a(a,d){a.call(this._object3DFacadesById[d],e,b,c)}var b=this.getChildByKey("scene").threeObject,c=this.getChildByKey("camera").threeObject,e=this._threeRenderer,f=this.eventRegistry;f.forEachListenerOfType("beforerender",a,this);e.render(b,c);f.forEachListenerOfType("afterrender",a,this);if(f=this.onStatsUpdate){var k=e.info,h=k.memory;k=k.render;h={"WebGL Draw Calls":k.calls,"WebGL Geometries":h.geometries,"WebGL Textures":h.textures,"WebGL Triangles":k.triangles};k.points&&(h["WebGL Points"]=
k.points);k.lines&&(h["WebGL Lines"]=k.lines);f(h)}};b.prototype.getFacadeUserSpaceXYZ=function(a){a=a.threeObject.matrixWorld.elements;return this.projectWorldPosition(a[12],a[13],a[14])};b.prototype.projectWorldPosition=function(a,b,c){A.set(a,b,c);a=this.getChildByKey("camera");a.updateMatrices();a=a.threeObject;A.applyMatrix4(a.matrixWorldInverse);b=A.length()*(0<A.z?-1:1);A.applyMatrix4(a.projectionMatrix);return new f.Vector3((A.x+1)*this.width/2,(1-A.y)*this.height/2,b)};b.prototype._normalizePointerEvent=
function(a){if(!a.ray){var b=a;if(a.touches){var g=/^touch(end|cancel)$/.test(a.type)?a.changedTouches:a.touches;1===g.length&&(b=g[0])}var e=a.target.getBoundingClientRect();g=((b.clientX||0)-(e.left||0))/(e.width||this.width)*2-1;b=((b.clientY||0)-(e.top||0))/(e.height||this.height)*-2+1;e=this.getChildByKey("camera");e.updateMatrices();a.ray=e.getRayAtProjectedCoords(g,b)}c.prototype._normalizePointerEvent.call(this,a)};b.prototype.getFacadesAtEvent=function(a,b){return a.ray?this.getFacadesOnRay(a.ray,
b):null};b.prototype.getFacadesOnRay=function(a,b){var c=this,d=this._updateOctree(),f=null;d&&(la.ray=a,d.forEachSphereOnRay(a,function(a,d){(a=(d=(a=c._object3DFacadesById)&&a[d])&&(!b||b(d))&&d.raycast&&d.raycast(la))&&a[0]&&(a[0].facade=d,(f||(f=[])).push(a[0]))}));return f};b.prototype._updateOctree=function(){var a=this._boundingSphereOctree,b=this._octreeChangeset;if(b){a||(a=this._boundingSphereOctree=new u);var c=b.remove;b=b.put;if(c)for(var e in c)a.removeSphere(e);if(b)for(var f in b)e=
this._object3DFacadesById[f],!e||e.isDestroying||c&&c[f]||((e=e.getBoundingSphere&&e.getBoundingSphere())?a.putSphere(f,e):a.removeSphere(f));this._octreeChangeset=null}return a};b.prototype._queueForOctreeChange=function(a,b){var c=this._octreeChangeset||(this._octreeChangeset={});(c[a]||(c[a]=Object.create(null)))[b.$facadeId]=b};b.prototype._onBgClick=function(a){if(a.target===a.currentTarget)this.onBackgroundClick(a)};b.prototype.destructor=function(){c.prototype.destructor.call(this);this._threeRenderer.dispose();
this._threeRenderer.forceContextLoss()};return b}(m.WorldBaseFacade);I.prototype._notifyWorldHandlers=D(Object.create(m.WorldBaseFacade.prototype._notifyWorldHandlers),{getCameraPosition:function(c,b){c=this.getChildByKey("camera").threeObject.matrixWorld.elements;c=new f.Vector3(c[12],c[13],c[14]);b.callback(c)},getCameraFacade:function(c,b){b.callback(this.getChildByKey("camera"))},getSceneFacade:function(c,b){b.callback(this.getChildByKey("scene"))},projectWorldPosition:function(c,b){c=b.worldPosition;
b.callback(this.projectWorldPosition(c.x,c.y,c.z))},object3DAdded:function(c){this._object3DFacadesById[c.$facadeId]=c;this._queueForOctreeChange("put",c)},object3DBoundsChanged:function(c){this._queueForOctreeChange("put",c)},object3DRemoved:function(c){delete this._object3DFacadesById[c.$facadeId];this._queueForOctreeChange("remove",c)},rayPointerMotion:function(c,b){var a=new MouseEvent("mousemove");a.isRayEvent=!0;a.ray=b;a.eventSource=c;this._onPointerMotionEvent(a)},rayPointerAction:function(c,
b){var a=new ("wheel"===b.type?WheelEvent:MouseEvent)(b.type,b);a.isRayEvent=!0;a.ray=b.ray;a.eventSource=c;this._onPointerActionEvent(a)}});var Fa="onMouseOver onMouseOut onMouseMove onMouseDown onMouseUp onClick onDoubleClick".split(" ");x=function(c){function b(a){var b=new f.Object3D;b.isRenderable=!1;b.$troikaVisible=b.visible;Object.defineProperty(b,"visible",Ga);c.call(this,a,b);this.notifyWorld("instanceableAdded")}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=
b;var a={instancedThreeObject:{configurable:!0}};a.instancedThreeObject.set=function(a){a!==this._instancedThreeObject&&(this._instancedThreeObject=a,this.notifyWorld("instanceableChanged"),this._boundsChanged=!0)};a.instancedThreeObject.get=function(){return this._instancedThreeObject};b.prototype.setInstanceUniform=function(a,b){var c=this._instanceUniforms||(this._instanceUniforms=Object.create(null));c[a]!==b&&(c[a]=b,this.notifyWorld("instanceableUniformChanged",a))};b.prototype.updateMatrices=
function(){var a=this._worldMatrixVersion;c.prototype.updateMatrices.call(this);this._worldMatrixVersion!==a&&this.threeObject.$troikaVisible&&this.notifyWorld("instanceableMatrixChanged")};b.prototype.destructor=function(){this.notifyWorld("instanceableRemoved");c.prototype.destructor.call(this)};b.prototype.getGeometry=function(){var a=this.instancedThreeObject;return a&&a.geometry};b.prototype.raycast=function(a){var b=this.instancedThreeObject,c=this.threeObject;if(b&&c){var d=b.matrixWorld;b.matrixWorld=
c.matrixWorld;a=this._raycastObject(b,a);b.matrixWorld=d;return a}return null};Object.defineProperties(b.prototype,a);return b}(q);var Ga={set:function(c){c!==this.$troikaVisible&&(this.$troikaVisible=c,this.$facade.notifyWorld("instanceableChanged"))},get:function(){return this.$troikaVisible}};m.utils.assign(x.prototype,{_lastInstancedMatrixVersion:-1,_instancedThreeObject:null});var J=function(c){function b(a){var b=this;c.call(this,a);this._onCanvasRef=function(a){var c=b.context.onCanvasRef;
c&&c(a);(c=b.props.onCanvasRef)&&c(a)}}c&&(b.__proto__=c);b.prototype=Object.create(c&&c.prototype);b.prototype.constructor=b;b.prototype.render=function(){var a=this.props,b=this.context;return y.createElement(c,m.utils.assign({},a,{onCanvasRef:this._onCanvasRef,canvasStyle:a.canvasStyle||b.canvasStyle,worldFacade:a.worldFacade||b.worldFacade||I,worldProps:m.utils.assign({antialias:a.antialias,rendererClass:a.rendererClass,backgroundColor:a.backgroundColor,shadows:a.shadows,camera:a.camera,lights:a.lights,
objects:a.objects,fog:a.fog,onBackgroundClick:a.onBackgroundClick},b.worldProps,a.worldProps)}),a.children)};return b}(m.ReactCanvasBase);J.displayName="Canvas3D";J.propTypes=m.utils.assignIf({backgroundColor:r.any,lights:r.array,camera:r.object,objects:r.oneOfType([r.array,r.object]).isRequired,antialias:r.bool,onBackgroundClick:r.func,rendererClass:r.func},m.ReactCanvasBase.commonPropTypes);J.contextType=y.createContext({worldFacade:I,worldProps:{},onCanvasRef:null,canvasStyle:null});Object.defineProperty(k,
"Facade",{enumerable:!0,get:function(){return m.Facade}});Object.defineProperty(k,"ListFacade",{enumerable:!0,get:function(){return m.ListFacade}});Object.defineProperty(k,"ParentFacade",{enumerable:!0,get:function(){return m.ParentFacade}});Object.defineProperty(k,"createDerivedMaterial",{enumerable:!0,get:function(){return v.createDerivedMaterial}});k.AmbientLight3DFacade=ca;k.Canvas3D=J;k.DirectionalLight3DFacade=da;k.Group3DFacade=ba;k.HtmlOverlay3DFacade=wa;k.Instanceable3DFacade=x;k.InstancingManager=
M;k.Object3DFacade=q;k.OrthographicCamera3DFacade=L;k.PerspectiveCamera3DFacade=aa;k.PointLight3DFacade=fa;k.Scene3DFacade=ka;k.SpotLight3DFacade=ea;k.World3DFacade=I;k.makeWorldTextureProvider=function(c){return function(b){function a(a){var c=this,d=new f.CanvasTexture;b.call(this,a,d);this.worldTexture=d;var k=this._refireAsInnerEvent.bind(this);Fa.forEach(function(a){function b(a){k(a);d&&d.call(this,a)}var d;c[a]=b;Object.defineProperty(c,a,{set:function(a){d=a},get:function(){return b}})})}
b&&(a.__proto__=b);a.prototype=Object.create(b&&b.prototype);a.prototype.constructor=a;a.prototype.afterUpdate=function(){var a=this,c=this._worldFacade,e=this.textureWorld;c&&e&&c instanceof e.facade||(c&&(c.onAfterRender=null,c.destructor()),e&&(this.worldTexture.dispose(),c=document.createElement("canvas"),c.width=c.height=2,this.worldTexture.image=c,c=this._worldFacade=new e.facade(c),c.onAfterRender=function(){a.worldTexture.needsUpdate=!0;a.notifyWorld("needsRender")}));c&&(c.renderingScheduler=
this._getOuterWorld().renderingScheduler,m.utils.assign(c,e),c.afterUpdate());b.prototype.afterUpdate.call(this)};a.prototype._refireAsInnerEvent=function(a){var b=this._worldFacade;if(b){var c=a.intersection&&a.intersection.uv,d=c?Math.round(c.x*b.width):-1;b=c?Math.round((1-c.y)*b.height):-1;a=a.nativeEvent||a;c=document.createEvent("MouseEvents");c.initMouseEvent(a.type,!0,!0,window,a.detail,d,b,d,b,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null);this.worldTexture.image.dispatchEvent(c)}};
a.prototype._getOuterWorld=function(){for(var a=this;a&&!a.isWorld;)a=a.parent;return a};a.prototype.destructor=function(){var a=this._worldFacade;a&&(a.onAfterRender=null,a.destructor());this.worldTexture.dispose();b.prototype.destructor.call(this)};return a}(c)};Object.defineProperty(k,"__esModule",{value:!0})});
